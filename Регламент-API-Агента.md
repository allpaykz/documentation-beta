# Техническое описание API операций Cash-In Cash-Out

Сервисы предназначены для осуществления операций «Снятие» и «Пополнение» через СЭД Allpay.

Перед чтением этой страницы желательно ознакомиться с [этой](https://github.com/allpaykz/documentation/wiki/%D0%9A%D0%B0%D0%BA%D0%B8%D0%B5-%D0%B2%D0%B8%D0%B4%D1%8B-%D0%B8%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D0%B9-%D1%83-%D0%BD%D0%B0%D1%81-%D0%B5%D1%81%D1%82%D1%8C)

**Примеры всех XML запросов в самом конце**

### СОДЕРЖАНИЕ

1. [WSDL ССЫЛКИ НА API](WSDL-ССЫЛКИ-НА-API)
1. [ПРИНЦИПЫ ВЗАИМОДЕЙСТВИЯ С ПС ALLPAY](#ПРИНЦИПЫ-ВЗАИМОДЕЙСТВИЯ-С-ПС-ALLPAY)
1. [СЦЕНАРИЙ СНЯТИЯ](#СЦЕНАРИЙ-СНЯТИЯ)
1. [ТЕХНИЧЕСКИЙ СЦЕНАРИЙ СНЯТИЯ](#ТЕХНИЧЕСКИЙ-СЦЕНАРИЙ-СНЯТИЯ)
1. [СЦЕНАРИЙ ПОПОЛНЕНИЯ](#СЦЕНАРИЙ-ПОПОЛНЕНИЯ)
1. [ТЕХНИЧЕСКИЙ СЦЕНАРИЙ ПОПОЛНЕНИЯ](#ТЕХНИЧЕСКИЙ-СЦЕНАРИЙ-ПОПОЛНЕНИЯ)
1. [ОПИСАНИЕ ФОРМАТА СООБЩЕНИЙ](#ОПИСАНИЕ-ФОРМАТА-СООБЩЕНИЙ)
 2. [ОБЩИЕ ПОЛЯ](#ОБЩИЕ-ПОЛЯ)
 2. [СНЯТИЕ](#СНЯТИЕ)
 2. [ПОПОЛНЕНИЕ](#ПОПОЛНЕНИЕ)
2. [ИСПОЛЬЗОВАНИЕ ТЕСТОВОЙ СИСТЕМЫ ALLPAY](#ИСПОЛЬЗОВАНИЕ-ТЕСТВОЙ-СИСТЕМЫ-ALLPAY)
2. [ПРИМЕРЫ ДЕМО РЕАЛИЗАЦИЙ](#ПРИМЕРЫ-РЕАЛИЗАЦИЙ)
 3. [НА ЯЗЫКЕ JAVA](#РЕАЛИЗАЦИЯ-НА-ЯЗЫКЕ-java)

### WSDL ССЫЛКИ НА API

* Тестовая среда, полностью идентична продакшн среде.
  * [Агентское API Пополнение&Снятие](https://beta.allpay.kz/allpay-public-soap/transaction-management/v1.0?wsdl) **v1.0** (Устарело/Deprecated)
  * [Агентское API Пополнение&Снятие](https://beta.allpay.kz/allpay-public-soap/transaction-management/v1.1?wsdl) **v1.1**
  * [Агентское API только Пополнение](https://beta.allpay.kz/allpay-public-soap/cash-in-transaction-management/v1.1?wsdl) (подходит для терминалов)

* Продакшн среда
  * [Агентское API Пополнение&Снятие](https://mfs.allpay.kz/allpay-public-soap/transaction-management/v1.0?wsdl) **v1.0** (Устарело/Deprecated)
  * [Агентское API Пополнение&Снятие](https://mfs.allpay.kz/allpay-public-soap/transaction-management/v1.1?wsdl) **v1.1**
  * [Агентское API только Пополнение](https://mfs.allpay.kz/allpay-public-soap/cash-in-transaction-management/v1.1?wsdl) (подходит для терминалов)

* Демо проект, реализация наших API - http://beta.allpay.kz/allpay-public-soap-demo/

### ПРИНЦИПЫ ВЗАИМОДЕЙСТВИЯ С ПС ALLPAY

Для обмена данными используется формат XML, для всех видов передаваемых сообщений определена [соответствующая схема XSD](http://allpay.kz/xsd/1.0.0/).

VPN каналы и шлюзы не используются. Для безопасного обмена сообщениями все XML подписываются обеими сторонами. Подпись реализована по стандарту W3C описанными в `XSD` схеме [XmlDSig](https://www.w3.org/TR/xmldsig-core/).
Каждое сообщение должно проходить валидацию по соответствующей XSD схеме, все обязательные поля должны быть заполнены по формату.

Используемая кодировка – UTF-8.

В большинстве схем обмена данными присутствуют общие поля. Все общие поля описаны схемой [OnlineTransactionCommons.xsd](http://allpay.kz/xsd/1.0.0/OnlineTransactionCommons.xsd).
Далее приведено описание и назначения каждого из общих полей.

### СЦЕНАРИЙ СНЯТИЯ

1. Клиент просит кассира Снять деньги с кошелька allpay
1. Клиент формирует "токен" в приложении allpay. Клиент передает токен и логин кошелька allpay Кассиру
2. Кассир формирует запрос на Снятие, используя токен и логин. Кассир отправляет запрос на сервер allpay
3. Кассир получает уведомление об успешной транзакции
4. Клиент получает пуш уведомление об успешной транзакции
4. Кассир передает наличные деньги Клиенту

### ТЕХНИЧЕСКИЙ СЦЕНАРИЙ СНЯТИЯ

1. Формируем запрос `createCashOutTransaction`
2. Метод создает транзакцию, блокирует деньги пользователя. Статус транзакции становится PENDING (ОЖИДАНИЕ).
3. Формируем запрос `completeTransaction`, номер транзакции берём из ответа от `createCashOutTransaction`
4. Получаем ответ, заблокированные деньги списываются. Статус транзакции становится COMPLETE (ЗАВЕРШЕН).

В случае проблем или ошибок после шага 2 или 3 транзакцию можно отменить используя метод `declineTransaction`.

### СЦЕНАРИЙ ПОПОЛНЕНИЯ

1. Клиент просит кассира Пополнить деньги на кошелёк allpay
2. Клиент передает наличные и логин кошелька allpay Кассиру
2. Кассир формирует запрос на Пополнение кошелька, используя логин Клиента. Кассир отправляет запрос на сервер allpay
3. Кассир получает уведомление об успешной транзакции
4. Клиент получает пуш уведомление об успешной транзакции

### ТЕХНИЧЕСКИЙ СЦЕНАРИЙ ПОПОЛНЕНИЯ

1. Формируем запрос `createCashInTransaction`
2. Метод создает транзакцию, блокирует деньги агента. Статус транзакции становится PENDING (ОЖИДАНИЕ).
3. Формируем запрос `completeTransaction`, номер транзакции берём из ответа от `createCashOutTransaction`
4. Получаем ответ, заблокированные деньги списываются. Статус транзакции становится COMPLETE (ЗАВЕРШЕН).

В случае проблем или ошибок после шага 2 или 3 транзакцию можно отменить используя метод `declineTransaction`.

### ОПИСАНИЕ ФОРМАТА СООБЩЕНИЙ

#### ОБЩИЕ ПОЛЯ

`language` — язык текстов. От него зависит на каком языке будут приходить тексты ошибок, статусов или других текстовых описаний.

`userName` — логин пользователя в системе Allpay. 

`amount` — сумма денег указанная в KZT

`commission` — Содержит комиссию на транзакцию

`transactionInfo` — Содержит информацию о транзакции:
 * `GUID` — уникальный идентификатор транзакции на стороне пользователя API
 * `amount` — сумма в KZT
 * `transactionId` — идентификатор транзакции
 * `transactionStatus` — статус транзакции
 * `commission` — комиссия на транзакцию

`onlineTransactionResponseHeader` — общее поле для всех ответов на запросы. Содержит:
 * `userMessage` — поле информативного характера. Обычно это сообщения, которое можно показать пользователю. Содержит описание ошибок, статусов и т.д.
 * `developerMessage` — поле информативного характера. Содержит техническое описание и коды ошибок.
 * `status` — Статус запроса. Описание статусов будет приведено ниже.
 * `timestamp` — дата ответа
 * `token` - токен

`transactionResponse` — содержит информацию о транзакции.
 * `header` — составное поле типа onlineTransactionResponseHeader
 * `transactionInfo` — составное поле типа transactionInfo

`onlineTransactionRequestHeader` — общее поле для всех запросов. Содержит:
 * `lang` — определяет язык. Поле типа language, описанного выше.
 * `timestamp` — дата отправки запроса.
 * `requester` — логин отправителя в системе Allpay.
 
#### СНЯТИЕ
 
 Для осуществления операции снятия используется схема OnlineTransactionCashOut. Далее будет приведено описание и назначение каждого поля.
 
* `cashOutRequest` — составное поле. Описывает все параметры запроса на «Снятие денег».
* `header` — составное поле типа onlineTransactionRequestHeader
* `fromUserName` — поле типа userName. С этого аккаунта происходит снятие денег.
* `amount` — поле типа amount
* `GUID` — поле типа GUID
* `token` — поле типа token

Запрос инициирует транзакцию, проверяет наличие денег, считает комиссии и ставит статус Pending. Для завершения или аннулирования транзакции нужно использовать методы `completeTransactionResponse` и `declineTransactionRequest` соответственно.

#### ПОПОЛНЕНИЕ
 
Для осуществления операции снятия используется схема OnlineTransactionCashIn. Далее будет приведено описание и назначение каждого поля.

* `cashInRequest` — составное поле. Описывает параметры запроса на «Пополнение» денег. Далее будет приведено описание и назначение каждого поля.	
* `header` — составное поле типа onlineTransactionRequestHeader
* `toUserName` — поле типа userName. На этот аккаунт происходит пополнение денег.
* `amount` — поле типа amount
* `GUID` — поле типа GUID

Запрос инициирует транзакцию, проверяет наличие денег, считает комиссии и ставит статус Pending. Для завершения или аннулирования транзакции нужно использовать методы `completeTransactionResponse` и `declineTransactionRequest` соответственно.

### ИСПОЛЬЗОВАНИЕ ТЕСТОВОЙ СИСТЕМЫ ALLPAY

Для тестирования сервисов можно подключится к тестовой инфраструктуре ПС Allpay. Запрос на получение доступа к тестовому серверу отправляйте на почту techsupport@allpay.kz

### ПРИМЕРЫ РЕАЛИЗАЦИЙ

Исходный код демо проектов находится [здесь](https://github.com/allpaykz/allpay-public/tree/master/allpay-public-soap)

##### РЕАЛИЗАЦИЯ НА ЯЗЫКЕ JAVA

Проект находится [здесь](https://github.com/allpaykz/allpay-public/tree/master/allpay-public-soap)
